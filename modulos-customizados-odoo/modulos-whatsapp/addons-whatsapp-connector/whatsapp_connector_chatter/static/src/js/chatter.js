odoo.define("whatsapp_connector_chatter.Chatter",(function(require){"use strict";var Widget=require("web.Widget"),AcruxChatAction=require("whatsapp_connector.acrux_chat").AcruxChatAction,chat=require("whatsapp_connector.chat_classes"),core=require("web.core"),session=require("web.session"),QWeb=core.qweb,Chatter=Widget.extend({events:{"click .o_acrux_chat_item":"selectConversation","click button.acrux_load_more":"loadMoreMessage"},init:function(parent,options){this._super.apply(this,arguments),this.partner_id=null,this.conv_ids=[],this.selected_conversation=null,this.whatsapp_limit=20,this.currency_id=null,this.props=this.getParent().props,this.promise_render=null,this.is_chatroom_installed=!0,this.show_user_in_message=null,this.selected_conversation_locked=!1,this.conversation_render_locked=!1,this.setPartner()},destroy:function(){this.selected_conversation=null,this._super.apply(this,arguments)},update:function(props){let prom=[];if(this.current_company_id=session.user_context.allowed_company_ids[0],this.needUpdate(props)?(this.props=props,this.setPartner(),this.props.isWhatsappTalkVisible&&prom.push(this.queryConversation()),this.currency_id||prom.push(AcruxChatAction.prototype.getCurrency.apply(this))):this.props=props,null===this.show_user_in_message){const userMjsPerm=session.user_has_group("whatsapp_connector.group_chat_show_user_in_message").then((hasGroup=>{this.show_user_in_message=hasGroup}));prom.push(userMjsPerm)}return Promise.all(prom)},render:function(){let out;return this.promise_render?out=Promise.resolve():(this.props.isWhatsappTalkVisible?out=this.renderWhatsapp():(this.do_hide(),out=Promise.resolve()),this.promise_render=out.then((()=>this.promise_render=null))),out},needUpdate:function(props){let flag=!1;return this.props.recId==props.recId?"res.partner"===this.props.modelName?(this.partner_id||props.recId)&&(flag=!this.partner_id||!props.recId||this.partner_id!=props.recId):(this.partner_id||props.originalState.data[props.fieldName])&&(flag=!this.partner_id||!props.originalState.data[props.fieldName]||this.partner_id!=props.originalState.data[props.fieldName].data.id):flag=!0,flag},clearData:function(){this.selected_conversation=null,this.conv_ids&&(this.conv_ids.forEach((x=>x.destroy())),this.conv_ids=[])},renderWhatsapp:function(){let $conv=$(QWeb.render("chatter.WhatsappConversation")),$el=$conv.find(".o_current_chats"),promises=[];return this.conv_ids.forEach((x=>promises.push(x.appendTo($el)))),Promise.all(promises).then((()=>{if(this.renderElement(),$conv.appendTo(this.$el),this.$chat_message=this.$("div.o_chat_thread"),this.selected_conversation)return this.renderConversation()}))},setPartner:function(){this.props.recId>0?"res.partner"===this.props.modelName?this.partner_id=this.props.recId:this.props.originalState.data[this.props.fieldName]?this.partner_id=this.props.originalState.data[this.props.fieldName].data.id:this.partner_id=null:this.partner_id=null,this.clearData()},queryConversation:function(){let out=Promise.resolve();return"acrux.chat.conversation"===this.props.modelName?this.props.recId>0?out=this._rpc({model:"acrux.chat.conversation",method:"build_dict",args:[[this.props.recId],this.whatsapp_limit]}).then((conv_ids=>{this.clearData(),this.conv_ids=conv_ids.map((conv=>new chat.Conversation(this,conv))),this.selected_conversation=this.conv_ids[0]})):this.clearData():this.partner_id?out=this._rpc({model:"acrux.chat.conversation",method:"search_conversation_by_partner",args:[this.partner_id,this.whatsapp_limit]}).then((conv_ids=>{this.clearData(),this.conv_ids=conv_ids.map((conv=>new chat.Conversation(this,conv))),this.selected_conversation=this.conv_ids[0]})):this.clearData(),out},selectConversation:function(event){let id=$(event.currentTarget).data("id");AcruxChatAction.prototype.lockSelectConversation.call(this).then((unlock=>{let conv_id=this.conv_ids.find((x=>x.id==id));if(conv_id&&(null==this.selected_conversation||this.selected_conversation.id!=conv_id.id))return this.selected_conversation=conv_id,this.renderConversation().finally(unlock);unlock()}))},renderConversation:function(){let $conv=this.$(`div.o_acrux_chat_item[data-id="${this.selected_conversation.id}"]`);return this.$(".o_acrux_chat_item").removeClass("active"),$conv.addClass("active"),this.renderMessage().then((()=>{let $message=this.$chat_message[0];$message.scrollTop=$message.scrollHeight-$message.clientHeight}))},renderMessage:function(){let out;if(this.$chat_message.empty(),this.selected_conversation.messages.length){let messages=this.selected_conversation.messages;out=this.selected_conversation._syncLoop(0,messages,-1,this.$chat_message)}else out=Promise.resolve();return out.then((()=>this.renderLoadBtn()))},renderLoadBtn:function(){if(this.$chat_message.find(".acrux_load_more").remove(),this.selected_conversation&&this.selected_conversation.messages.length%this.whatsapp_limit==0&&this.selected_conversation.messages.length){var btn=QWeb.render("whatsapp.connector.load_more_btn");this.$chat_message.prepend(btn)}},loadMoreMessage:function(){let out=Promise.resolve();if(this.selected_conversation.messages.length>=this.whatsapp_limit){var select=this.selected_conversation;out=this._rpc({model:"acrux.chat.conversation",method:"build_dict",args:[[select.id],this.whatsapp_limit,select.messages.length]}).then((async result=>{if(result[0].messages)return select.addExtraClientMessage(result[0].messages).then((()=>this.renderLoadBtn()))}))}return out},format_monetary:function(val){return AcruxChatAction.prototype.format_monetary.call(this,val)},lockRenderConversation:function(){return AcruxChatAction.prototype.lockRenderConversation.call(this)}});return core.action_registry.add("acrux.chat.hide_chatter_whatsapp_tag",(function(_self,_action,_options){let el=document.querySelector(".o_ChatterTopbar_whatsapp");return el&&el.classList.contains("o-active")&&el.click(),{type:"ir.actions.act_window_close"}})),Chatter}));